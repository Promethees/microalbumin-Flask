<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            display: flex;
            justify-content: center;
        }
        .container {
            max-width: 50vw;
            width: 100%;
        }
        .section { margin-bottom: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        #data-display { max-height: 300px; overflow-y: auto; }
        #error-message { color: red; display: none; }
        #file-table-container { max-height: 120px; overflow-y: auto; }
        #file-table { width: 100%; }
        #file-table tr.selected { background-color: #e0f7fa; }
        #file-table button { cursor: pointer; }
        #directory { width: 70%; }
        #dir-suggestions { margin-top: 5px; }
        #parent-dir, #child-dirs { margin-top: 5px; max-height: 100px; overflow-y: auto; }
        #parent-dir h3, #child-dirs h3 { margin: 0; font-size: 1em; font-weight: bold; }
        #parent-dir div, #child-dirs div { padding: 5px; cursor: pointer; }
        #parent-dir div:hover, #child-dirs div:hover { background-color: #f0f0f0; }
        #deselect-btn { margin-top: 5px; padding: 5px 10px; }
        #plot-canvas, #blanked-canvas, #non-blanked-canvas { width: 100%; height: 280px; }
        #chart-container { display: flex; flex-direction: column; gap: 20px; }
        #mode-toggle { margin-bottom: 10px; }
        #analysis-info { margin-top: 10px; font-size: 0.9em; color: #333; }
        #wd-size-error {color: red; display: none; }
        #log-display { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background-color: #f9f9f9; white-space: pre-wrap; }
        .script-controls { margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ title }}</h1>
        
        <div class="section">
            <h2>Directory</h2>
            <input type="text" id="directory" value="{{ directory }}" onchange="updateDirectory(this.value)">
            <button onclick="browseDirectory()">Browse Path</button>
            <div id="dir-suggestions">
                <h3>Go back</h3>
                <div id="parent-dir"></div>
                <h3>Go forward</h3>
                <div id="child-dirs"></div>
            </div>
            <div id="error-message"></div>
        </div>

        <div class="section script-controls">
            <h2>Log HID Data</h2>
            <div>
                <label for="base-dir">Base Directory (--base-dir): </label>
                <input type="text" id="base-dir" placeholder="Leave empty for default">
            </div>
            <div>
                <label for="base-name">Base Name (--base-name): </label>
                <input type="text" id="base-name" placeholder="Enter a name">
            </div>
            <button id="run-script-btn" onclick="runScript()">Run Script</button>
            <button id="terminate-script-btn" onclick="terminateScript()" disabled>Terminate Script</button>
            <button id="clear-logs-btn" onclick="clearLogs()">Clear Logs</button>
            <div id="log-display"></div>
        </div>
        
        <div class="section">
            <h2>{{ range_input.title }}</h2>
            <input type="number" id="range-value" value="{{ range_input.value }}" min="1">
            <select id="time-unit">
                {% for unit in range_input.units %}
                <option value="{{ unit }}">{{ unit }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="section">
            <h2>Window size</h2>
            <h3>Select window size for Vmax regression</h3>
            <input type="number" id="window-size" value="4" min="3">
            <div id="wd-size-error"></div>
        </div>
        
        <div class="section">
            <h2>File Selection</h2>
            <div id="file-table-container">
                <table id="file-table">
                    <tr><th>File Name</th><th>Action</th></tr>
                    {% if file_list %}
                        {% for file in file_list %}
                        <tr>
                            <td>{{ file }}</td>
                            <td><button onclick="selectFile('{{ file }}', this)">Select</button></td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="2">No CSV files found in the directory.</td></tr>
                    {% endif %}
                </table>
            </div>
            <button id="deselect-btn" onclick="deselectFile()">Deselect</button>
        </div>
        
        <div class="section">
            <h2>Data Display</h2>
            <div id="mode-toggle">
                <label>
                    <input type="checkbox" id="split-mode" onchange="toggleMode()"> Split by Blanked
                </label>
                <label>
                    <input type="checkbox" id="full-display" onchange="toggleMode()">Full display: See all data and special lines
                </label>
            </div>
            <div id="analysis-info"></div>
            <div id="chart-container">
                <canvas id="plot-canvas"></canvas>
                <canvas id="blanked-canvas" style="display: none;"></canvas>
                <canvas id="non-blanked-canvas" style="display: none;"></canvas>
            </div>
        </div>
    </div>

    <script>
        let blankedChart = null;
        let nonBlankedChart = null;
        let myChart = null;
        let scriptRunning = false;

        $(document).ready(function() {
            $.get('/get_parents', function(parentResponse) {
                console.log("Parent directory:", parentResponse.parent);
                let parentHtml = parentResponse.parent ? 
                    `${parentResponse.parent.split('/').pop() ? 
                        `<div onclick="updateDirectory('${parentResponse.parent}')">${parentResponse.parent.split('/').pop()}</div>` : 
                        '<div>No parent directory</div>'}` : 
                    '<div>No parent directory</div>';
                $("#parent-dir").html(parentHtml);

                $.get('/get_children', function(childResponse) {
                    console.log("Child directories:", childResponse.children);
                    let childHtml = childResponse.children.length > 0 ? 
                        `${childResponse.children.map(dir => 
                            `<div onclick="updateDirectory('${dir}')">${dir.split('/').pop()}</div>`
                        ).join('')}` : 
                        '<div>No child directories</div>';
                    $("#child-dirs").html(childHtml);
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.log("Error fetching child directories:", textStatus, errorThrown);
                    $("#error-message").text("Error fetching child directories").show();
                });
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.log("Error fetching parent directory:", textStatus, errorThrown);
                $("#error-message").text("Error fetching parent directory").show();
            });
            // Poll logs every 2 seconds if script is running as new data is being updated
            setInterval(function() {
                if (scriptRunning) {
                    fetchLogs();
                }
            }, 2000);

            // Periodically update file table every 5 seconds
            setInterval(function() {
                const currentDir = $("#directory").val();
                if (currentDir) {
                    updateDirectory(currentDir);
                }
            }, 5000);
        });

        function browseDirectory() {
            $.get('/get_parents', function(parentResponse) {
                console.log("Parent directory:", parentResponse.parent);
                let parentHtml = parentResponse.parent ? 
                    `${parentResponse.parent.split('/').pop() ? 
                        `<div onclick="updateDirectory('${parentResponse.parent}')">${parentResponse.parent.split('/').pop()}</div>` : 
                        '<div>No parent directory</div>'}` : 
                    '<div>No parent directory</div>';
                $("#parent-dir").html(parentHtml);

                $.get('/get_children', function(childResponse) {
                    console.log("Child directories:", childResponse.children);
                    let childHtml = childResponse.children.length > 0 ? 
                        `${childResponse.children.map(dir => 
                            `<div onclick="updateDirectory('${dir}')">${dir.split('/').pop()}</div>`
                        ).join('')}` : 
                        '<div>No child directories</div>';
                    $("#child-dirs").html(childHtml);
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.log("Error fetching child directories:", textStatus, errorThrown);
                    $("#error-message").text("Error fetching child directories").show();
                });
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.log("Error fetching parent directory:", textStatus, errorThrown);
                $("#error-message").text("Error fetching parent directory").show();
            });
        }

        function updateDirectory(path) {
            console.log("Sending path to server:", path);
            $.post('/browse', {path: path}, function(response) {
                console.log("Server response:", response);
                if (response.status === 'success') {
                    $("#directory").val(response.path);
                    $("#error-message").hide();
                    updateFileTable(response.files);
                    deselectFile();
                } else {
                    $("#error-message").text(response.message).show();
                }
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.log("AJAX error:", textStatus, errorThrown);
                $("#error-message").text("Error updating directory").show();
            });
        }

        function updateFileTable(files) {
            console.log("Updating file table with:", files);
            let html = '<tr><th>File Name</th><th>Action</th></tr>';
            if (files && files.length > 0) {
                files.forEach(file => {
                    html += `<tr><td>${file}</td><td><button onclick="selectFile('${file}', this)">Select</button></td></tr>`;
                });
            } else {
                html += '<tr><td colspan="2">No CSV files found in the directory.</td></tr>';
            }
            $("#file-table").html(html);
            currentFile = null;
            $("#file-table tr").removeClass("selected");
        }

        function runScript() {
            const baseDir = $("#base-dir").val() || "";
            const baseName = $("#base-name").val() || "";
            $.ajax({
                url: '/run_script',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ base_dir: baseDir, base_name: baseName }),
                success: function(response) {
                    console.log("Run script response:", response);
                    if (response.status === 'success') {
                        scriptRunning = true;
                        $("#run-script-btn").prop('disabled', true);
                        $("#terminate-script-btn").prop('disabled', false);
                        $("#base-dir").prop('disabled', true);
                        $("#base-name").prop('disabled', true);
                        $("#log-display").text("Script started...\n");
                    } else {
                        $("#log-display").text(`Error: ${response.message}\n`);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log("AJAX error:", textStatus, errorThrown);
                    $("#log-display").text(`Error: Failed to start script\n`);
                }
            });
        }

        function terminateScript() {
            $.ajax({
                url: '/terminate_script',
                type: 'POST',
                contentType: 'application/json',
                success: function(response) {
                    console.log("Terminate script response:", response);
                    if (response.status === 'success') {
                        scriptRunning = false;
                        $("#run-script-btn").prop('disabled', false);
                        $("#base-dir").prop('disabled', false);
                        $("#base-name").prop('disabled', false);
                        $("#terminate-script-btn").prop('disabled', true);
                        $("#log-display").append("Script terminated.\n");
                    } else {
                        $("#log-display").append(`Error: ${response.message}\n`);
                        // Attempt to re-enable run button if termination failed
                        if (response.message.includes('No process running')) {
                            scriptRunning = false;
                            $("#run-script-btn").prop('disabled', false);
                            $("#base-dir").prop('disabled', false);
                            $("#base-name").prop('disabled', false);
                            $("#terminate-script-btn").prop('disabled', true);
                        }
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log("AJAX error:", textStatus, errorThrown);
                    $("#log-display").append(`Error: Failed to terminate script\n`);
                    // Fallback to re-enable run button on error
                    scriptRunning = false;
                    $("#run-script-btn").prop('disabled', false);
                    $("#terminate-script-btn").prop('disabled', true);
                }
            });
        }

        function fetchLogs() {
            $.get('/get_logs', function(response) {
                console.log("Logs response:", response);
                if (response.status === 'success') {
                    $("#log-display").text(response.logs);
                }
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.log("AJAX error:", textStatus, errorThrown);
                $("#log-display").append(`Error: Failed to fetch logs\n`);
            });
        }

        function clearLogs() {
            $("#log-display").text("");
        }

        function selectFile(filename, button) {
            console.log("Selected file:", filename);
            $("#file-table tr").removeClass("selected");
            $(button).closest("tr").addClass("selected");
            let range = $("#range-value").val();
            let unit = $("#time-unit").val();
            let window_size = $("#window-size").val();
            if (window_size < 3) {
                $("#wd-size-error").text("Window size must be greater than 3.").show();
                return;
            } else {
                if (!Number.isInteger(parseInt(window_size, 10)) || window_size === '' || isNaN(window_size)) {
                    $("#wd-size-error").text("Window size must be must be Integer.").show();
                    return;
                } else {
                    $("#wd-size-error").hide();
                }
            }
            fetchData(range, unit, window_size, filename);
            currentFile = filename;
        }

        function deselectFile() {
            console.log("Deselecting file");
            $("#file-table tr").removeClass("selected");
            destroyCharts();
            $("#plot-canvas, #blanked-canvas, #non-blanked-canvas").hide();
            currentFile = null;
            $("#analysis-info").text("");
        }

        function fetchData(range, unit, window_size, filename) {
            $.get('/get_data', {
                file: $("#directory").val() + '/' + filename,
                range: range,
                unit: unit,
                window_size: window_size
            }, function(response) {
                console.log("Data response:", response);
                if (response.data && response.data.length > 0) {
                    if (window_size > response.data.length/2) {
                        $("#plot-canvas, #blanked-canvas, #non-blanked-canvas").hide()
                        $("#analysis-info").html(`<span style="color: red;">Window Size is greater than half of data size. The file has only ${response.data.length} data points</span>`);
                    }
                    else {
                        const isSplitMode = $("#split-mode").is(":checked");
                        const isFullDisplay = $("#full-display").is(":checked");
                        const displayRangeInput = document.getElementById('range-value');
                        const fullDisplayCheckbox = document.getElementById('full-display');

                        fullDisplayCheckbox.addEventListener('change', function() {
                            const originalValue = displayRangeInput.input;
                            if (this.checked) {
                                displayRangeInput.disabled = true;
                                displayRangeInput.placeholder = "Disabled by Full Display";
                                displayRangeInput.value = "";
                            } else {
                                displayRangeInput.disabled = false;
                                displayRangeInput.value = 1000;
                            }
                        })
                        updatePlot(response.data, range, unit, window_size, response.unit || "NONE", isSplitMode, isFullDisplay);
                    }
                } else {
                    $("#plot-canvas, #blanked-canvas, #non-blanked-canvas").hide()
                    $("#analysis-info").html(`<span style="color: red;">No data available</span>`);
                }
            });
        }

        function destroyCharts() {
            if (myChart) {
                myChart.destroy();
                myChart = null;
            }
            if (blankedChart) {
                blankedChart.destroy();
                blankedChart = null;
            }
            if (nonBlankedChart) {
                nonBlankedChart.destroy();
                nonBlankedChart = null;
            }
        }

        function toggleMode() {
            if (currentFile) {
                let range = $("#range-value").val();
                let unit = $("#time-unit").val();
                fetchData(range, unit, currentFile);
            }
        }

        function calculateSlopeAndSaturation(allTimestamps, allValues, window_size) {
            if (allTimestamps.length < 2 || allValues.length < 2 || window_size < 2 || window_size > allTimestamps.length) {
                return { slope: 0, intercept: 0, saturationValue: "--", timeToSaturation: "--", Vmax: 0, linearSlope: 0, linearYMin: 0, linearYMax: 0, linearXMin: 0, linearXMax: 0 };
            }

            // Function to calculate R-squared for linear regression
            function calculateRSquared(x, y, slope, intercept) {
                let n = x.length;
                let sumY = y.reduce((a, b) => a + b, 0);
                let meanY = sumY / n;
                let ssTot = y.reduce((a, b) => a + Math.pow(b - meanY, 2), 0);
                let ssRes = x.reduce((a, b, i) => a + Math.pow(y[i] - (slope * b + intercept), 2), 0);
                return ssTot === 0 ? 1 : 1 - ssRes / ssTot;
            }

            // Calculate local slopes and R-squared for each window
            let localSlopes = [];
            let intercepts = [];
            let rSquaredValues = [];
            for (let i = 0; i <= allTimestamps.length - window_size; i++) {
                let x = allTimestamps.slice(i, i + window_size);
                let y = allValues.slice(i, i + window_size);

                let n = x.length;
                let sumX = x.reduce((a, b) => a + b, 0);
                let sumY = y.reduce((a, b) => a + b, 0);
                let sumXY = x.reduce((a, b, i) => a + b * y[i], 0);
                let sumXX = x.reduce((a, b) => a + b * b, 0);

                let slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX) || 0; // in units/second
                let intercept = (sumY - slope * sumX) / n;

                let rSquared = calculateRSquared(x, y, slope, intercept);
                localSlopes.push(slope);
                intercepts.push(intercept);
                rSquaredValues.push(rSquared);
            }

            // Find Vmax (maximum slope with R-squared >= 0.95)
            let Vmax = 0;
            let threshold = 0.2 // Vmax must be larger than threshold per hour
            let startVMax = -1;
            let endVMax = -1;
            let yVMaxstart = 0;
            let yVMaxend = 0;
            for (let i = 0; i < localSlopes.length; i++) {
                adjustedLocal = 3600*localSlopes[i];
                console.log("local Slop is ", adjustedLocal);
                if (rSquaredValues[i] >= 0.95 && localSlopes[i] > Vmax && adjustedLocal > threshold) {
                    Vmax = localSlopes[i];
                    startVMax = Number(i);
                    endVMax = startVMax + Number(window_size) - 1;
                    yVMaxstart = Vmax*allTimestamps[startVMax] + intercepts[i];
                    yVMaxend = Vmax*allTimestamps[endVMax] + intercepts[i];
                }
            }
            
            
            // Determine linear period (slopes >= 0.8 * Vmax)
            let linearStartIdx = -1;
            let linearEndIdx = -1;
            if (Vmax !== 0) {
                for (let i = 0; i < localSlopes.length; i++) {
                    if (localSlopes[i] >= 0.7 * Vmax) {
                        if (linearStartIdx === -1) linearStartIdx = i;
                        linearEndIdx = i;
                    }
                }
            }
            

            // Calculate linear period parameters
            let linearSlope = null;
            let linearIntercept = 0;
            let linearXMin = 0;
            let linearXMax = 0;
            let linearYMin = 0;
            let linearYMax = 0;
            let saturationValue = "--";
            let timeToSaturation = "--";

            if (linearStartIdx !== -1 && linearEndIdx !== -1) {
                // Adjust indices to include full window at the end
                let start = linearStartIdx;
                let end = linearEndIdx + window_size;

                if (end > allTimestamps.length) {
                    end = allTimestamps.length;
                }

                let x = allTimestamps.slice(start, end);
                let y = allValues.slice(start, end);

                // Linear regression for the entire linear period
                let n = x.length;
                let sumX = x.reduce((a, b) => a + b, 0);
                let sumY = y.reduce((a, b) => a + b, 0);
                let sumXY = x.reduce((a, b, i) => a + b * y[i], 0);
                let sumXX = x.reduce((a, b) => a + b * b, 0);

                linearSlope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX) || 0; // In units/second
                linearIntercept = (sumY - linearSlope * sumX) / n;

                linearXMin = allTimestamps[start]; //in seconds
                linearXMax = allTimestamps[end - 1];
                linearYMin = linearSlope*linearXMin + linearIntercept; // in units (absorbance)
                linearYMax = linearSlope*linearXMax + linearIntercept;

                // Saturation point (end of linear period)
                // saturationValue = end < allValues.length ? linearYMax.toFixed(2) : "--";
                if (end >= allValues.length) {
                    saturationValue = "--";
                } else {
                    let theRest = allValues.slice(end, allValues.length);
                    sortedValuesForRest = [...theRest].sort((a, b) => a - b);
                    saturationValue = sortedValuesForRest[Math.floor(theRest.length/2)].toFixed(2);
                }
                timeToSaturation = end < allTimestamps.length ? (allTimestamps[end - 1] - allTimestamps[start]).toFixed(2) : null;
                timeStartSaturation = end < allTimestamps.length ? (allTimestamps[end - 1]).toFixed(2) : null;
            } else {
                sortedValues = [...allValues].sort((a, b) => a - b);
                saturationValue = sortedValues[allValues.length/2];
                timeToSaturation = allTimestamps[0];
                timeStartSaturation = allTimestamps[0];
            }
            console.log("time to saturation ", timeToSaturation);
            return {
                slope: linearSlope, // Overall slope for compatibility
                intercept: linearIntercept.toFixed(2),
                saturationValue,
                timeToSaturation,
                Vmax: Vmax.toFixed(6),
                linearYMin: linearYMin.toFixed(2),
                linearYMax: linearYMax.toFixed(2),
                linearXMin: linearStartIdx !== -1 ? linearXMin.toFixed(2) : null,
                linearXMax: linearEndIdx !== -1 ? linearXMax.toFixed(2) : null,
                startVMax: startVMax !== -1 ? allTimestamps[startVMax].toFixed(2) : null,
                endVMax: endVMax !== -1 ? allTimestamps[endVMax].toFixed(2) : null,
                yVMaxstart: yVMaxstart,
                yVMaxend: yVMaxend,
                timeStartSaturation: timeStartSaturation,
            };
        }

        function createChart(canvasId, timestamps, values, label, unit, timeUnit, range, conversionFactor, analysis, isFullDisplay) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (!ctx || timestamps.length === 0 || values.length === 0) {
                console.error("Invalid chart data or context:", { canvasId, timestamps, values });
                return null;
            }
            console.log(analysis);
            let chartScaleConstant = 60;
            let adjustedSlope = analysis.slope ? (parseFloat(analysis.slope)/conversionFactor).toFixed(4) : "--";
            let adjustedLinearStart = analysis.linearXMin ? (parseFloat(analysis.linearXMin)*conversionFactor).toFixed(2) : "--";
            let adjustedLinearEnd = analysis.linearXMax ? (parseFloat(analysis.linearXMax)*conversionFactor).toFixed(2) : "--";
            let adjustedVmax = parseFloat(analysis.Vmax)/conversionFactor;
            let adjustedVmaxStart = analysis.startVMax ? (parseFloat(analysis.startVMax)*conversionFactor).toFixed(2) : "--";
            let adjustedVmaxEnd = analysis.endVMax ? (parseFloat(analysis.endVMax)*conversionFactor).toFixed(2) : "--";
            let adjustedTimeToSaturationDisplay = (analysis.timeToSaturation !== null) ? (parseFloat(analysis.timeToSaturation) * conversionFactor).toFixed(2) : "--";
            adjustedVmax = (3600*adjustedVmax).toFixed(5) !== "0.00000" ? adjustedVmax.toFixed(5) : "--";

            let chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: label,
                        data: values,
                        borderColor: canvasId === 'blanked-canvas' ? 'rgb(255, 99, 132)' : 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    animation: false,
                    scales: {
                        x: {
                            title: { display: true, text: `Time (${timeUnit})` }
                        },
                        y: {
                            title: { display: true, text: unit !== "NONE" ? unit : '' },
                            suggestedMin: 0
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                ...(isFullDisplay && analysis.startVMax && {VMaxLine: {
                                      type: 'line',
                                      borderColor: 'rgba(255, 0, 0, 0.5)',
                                      borderWidth: 3,
                                      xMin: parseFloat((analysis.startVMax - timestamps[0])/chartScaleConstant),
                                      // xMin: 0,
                                      xMax: parseFloat((analysis.endVMax - timestamps[0])/chartScaleConstant),
                                      yMin: parseFloat(analysis.yVMaxstart),
                                      yMax: parseFloat(analysis.yVMaxend),
                                      label: {
                                        display: true,
                                        content: 'VMax',
                                        position: 'start'
                                      }
                                    }
                                }),
                                ...(isFullDisplay && analysis.linearXMin && {regressionLine: {
                                      type: 'line',
                                      borderColor: 'rgba(0, 0, 255, 0.5)',
                                      borderWidth: 3,
                                      xMin: parseFloat((analysis.linearXMin - timestamps[0])/chartScaleConstant),
                                      xMax: parseFloat((analysis.linearXMax - timestamps[0])/chartScaleConstant),
                                      yMin: parseFloat(analysis.linearYMin),
                                      yMax: parseFloat(analysis.linearYMax),
                                      label: {
                                        display: true,
                                        content: 'Linear',
                                        position: 'middle'
                                      }
                                    }
                                }),
                                ...(isFullDisplay && analysis.saturationValue !== "--" && {saturationLine: {
                                      type: 'line',
                                      borderColor: 'rgba(255, 0, 255, 0.5)',
                                      borderWidth: 3,
                                      xMin: parseFloat((analysis.timeStartSaturation - timestamps[0])/chartScaleConstant),
                                      xMax: Math.max(...timestamps)*100,
                                      yMin: parseFloat(analysis.saturationValue),
                                      yMax: parseFloat(analysis.saturationValue),
                                      label: {
                                        display: true,
                                        content: 'Sat',
                                        position: 'end'
                                      }
                                    }
                                })
                            }
                        }
                    }
                }
            });
            chart.data.datasets[0].analysis = {
                slope: adjustedSlope,
                linearStart: adjustedLinearStart,
                linearEnd: adjustedLinearEnd,
                saturationValue: analysis.saturationValue,
                timeToSaturation: adjustedTimeToSaturationDisplay,
                Vmax: adjustedVmax,
                VmaxStart: adjustedVmaxStart,
                VmaxEnd: adjustedVmaxEnd
            }; // Store adjusted analysis for display
            return chart;
        }

        function updatePlot(data, range, timeUnit, window_size, unit, isSplitMode, isFullDisplay) {
            destroyCharts();
            $("#plot-canvas, #blanked-canvas, #non-blanked-canvas").hide();
            $("#analysis-info").text("");

            const baseMultiplier = getTimeUnitMultiplier('seconds'); // Data is in seconds
            const targetMultiplier = getTimeUnitMultiplier(timeUnit); // Multiplier for target unit
            const conversionFactor = baseMultiplier / targetMultiplier; // Convert from seconds to target unit

            // Calculate slope and saturation using full dataset before filtering
            const allTimestamps = data.map(row => row['Timestamp']); // Unfiltered timestamps in seconds
            const allValues = data.map(row => row['Value']); // Unfiltered values
            const allBlankedData = data.filter(row => row['Blanked'] === true || row['Blanked'] === 1);
            const allNonBlankedData = data.filter(row => row['Blanked'] === false || row['Blanked'] === 0);
            
            const allBlankedTimestamps = allBlankedData.map(row => row['Timestamp']);
            const allBlankedValues = allBlankedData.map(row => row['Value']);

            const allNonBlankedTimestamps = allNonBlankedData.map(row => row['Timestamp']);
            const allNonBlankedValues = allNonBlankedData.map(row => row['Value']);
       
            // Convert range from the current timeUnit to seconds for filtering
            if (isFullDisplay === true) {
                range = Number.MAX_VALUE;
            }
            const rangeInSeconds = range * getTimeUnitMultiplier(timeUnit); // range is in timeUnit, convert to seconds
            const mostRecentTime = Math.max(...allTimestamps);
            const timeThreshold = mostRecentTime - rangeInSeconds;

            const filteredData = data.filter(row => row['Timestamp'] >= timeThreshold);
            if (filteredData.length === 0) {
                console.warn("No data after filtering with threshold:", timeThreshold);
                return;
            }
            const timestamps = filteredData.map(row => Number((row['Timestamp'] * conversionFactor).toFixed(2)));
            const values = filteredData.map(row => row['Value']);
            const measurementLabel = filteredData.length > 0 && 'Measurement' in filteredData[0] ? 
                filteredData[0]['Measurement'] : 'Measurement';

            if (isSplitMode) {
                const blankedData = filteredData.filter(row => row['Blanked'] === true || row['Blanked'] === 1);
                const nonBlankedData = filteredData.filter(row => row['Blanked'] === false || row['Blanked'] === 0);

                const blankedTimestamps = blankedData.map(row => Number((row['Timestamp'] * conversionFactor).toFixed(2)));
                const blankedValues = blankedData.map(row => row['Value']);
                const nonBlankedTimestamps = nonBlankedData.map(row => Number((row['Timestamp'] * conversionFactor).toFixed(2)));
                const nonBlankedValues = nonBlankedData.map(row => row['Value']);

                const analysis_blanked = calculateSlopeAndSaturation(allBlankedTimestamps, allBlankedValues, window_size);
                const analysis_nonblanked = calculateSlopeAndSaturation(allNonBlankedTimestamps, allNonBlankedValues, window_size);

                $("#blanked-canvas, #non-blanked-canvas").show();
                blankedChart = createChart(
                    'blanked-canvas',
                    blankedTimestamps,
                    blankedValues,
                    `${measurementLabel} (Blanked) ${unit !== "NONE" ? `(${unit})` : ""}`,
                    unit,
                    timeUnit,
                    range,
                    conversionFactor,
                    analysis_blanked,
                    isFullDisplay
                );
                nonBlankedChart = createChart(
                    'non-blanked-canvas',
                    nonBlankedTimestamps,
                    nonBlankedValues,
                    `${measurementLabel} (Non-Blanked) ${unit !== "NONE" ? `(${unit})` : ""}`,
                    unit,
                    timeUnit,
                    range,
                    conversionFactor,
                    analysis_nonblanked,
                    isFullDisplay
                );
                $("#analysis-info").html(
                    `<span style="color: rgb(255, 99, 132);">
                    Blanked: Slope = ${blankedChart?.data.datasets[0].analysis.slope} ${unit !== "NONE" ? unit : ''}/${timeUnit}, 
                    Linear start = ${blankedChart?.data.datasets[0].analysis.linearStart} ${timeUnit},
                    Linear end = ${blankedChart?.data.datasets[0].analysis.linearEnd} ${timeUnit}, <br/>
                    Vmax = ${blankedChart?.data.datasets[0].analysis.Vmax}${unit !== "NONE" ? unit : ''}/${timeUnit}, 
                    VmaxStart = ${blankedChart?.data.datasets[0].analysis.VmaxStart} ${timeUnit}, 
                    VmaxEnd = ${blankedChart?.data.datasets[0].analysis.VmaxEnd} ${timeUnit}, <br/>
                    Saturation = ${blankedChart?.data.datasets[0].analysis.saturationValue}, 
                    Time to Saturation = ${blankedChart?.data.datasets[0].analysis.timeToSaturation} ${timeUnit}<br> </span>` +
                    `<span style="color: rgb(75, 192, 192);">
                    Non-Blanked: Slope = ${nonBlankedChart?.data.datasets[0].analysis.slope} ${unit !== "NONE" ? unit : ''}/${timeUnit}, 
                    Linear start = ${nonBlankedChart?.data.datasets[0].analysis.linearStart} ${timeUnit},
                    Linear end = ${nonBlankedChart?.data.datasets[0].analysis.linearEnd} ${timeUnit}, <br/>
                    Vmax = ${nonBlankedChart?.data.datasets[0].analysis.Vmax}${unit !== "NONE" ? unit : ''}/${timeUnit}, 
                    VmaxStart = ${nonBlankedChart?.data.datasets[0].analysis.VmaxStart} ${timeUnit}, 
                    VmaxEnd = ${nonBlankedChart?.data.datasets[0].analysis.VmaxEnd} ${timeUnit}, <br/>
                    Saturation = ${nonBlankedChart?.data.datasets[0].analysis.saturationValue}, 
                    Time to Saturation = ${nonBlankedChart?.data.datasets[0].analysis.timeToSaturation} ${timeUnit} </span>`
                );
            } else {
                const analysis = calculateSlopeAndSaturation(allTimestamps, allValues, window_size);
                $("#plot-canvas").show();
                myChart = createChart(
                    'plot-canvas',
                    timestamps,
                    values,
                    `${measurementLabel} ${unit !== "NONE" ? `(${unit})` : ""}`,
                    unit,
                    timeUnit,
                    range,
                    conversionFactor,
                    analysis, 
                    isFullDisplay
                );
                const analysisDisplay = myChart?.data.datasets[0].analysis;
                $("#analysis-info").html(
                    `Slope = ${analysisDisplay.slope} ${unit !== "NONE" ? unit : ''}/${timeUnit},  
                    Linear start = ${analysisDisplay.linearStart} ${timeUnit},
                    Linear end = ${analysisDisplay.linearEnd} ${timeUnit}, <br/>
                    Vmax = ${analysisDisplay.Vmax}${unit !== "NONE" ? unit : ''}/${timeUnit}, 
                    VmaxStart = ${analysisDisplay.VmaxStart} ${timeUnit}, 
                    VmaxEnd = ${analysisDisplay.VmaxEnd} ${timeUnit}, <br/>
                    Saturation = ${analysisDisplay.saturationValue}, 
                    Time to Saturation = ${analysisDisplay.timeToSaturation} ${timeUnit}`
                );
            }
        }

        function getTimeUnitMultiplier(unit) {
            const multipliers = {
                'seconds': 1,
                'minutes': 60,
                'hours': 3600
            };
            return multipliers[unit] || 1;
        }

        let currentFile = null;
        setInterval(function() {
            if (currentFile) {
                let range = $("#range-value").val();
                let unit = $("#time-unit").val();
                let window_size = $("#window-size").val();
                fetchData(range, unit, window_size, currentFile);
            }
        }, 500);

        $("#range-value, #time-unit", "#window-size", "#full-display").on('change', function() {
            if (currentFile) {
                let range = $("#range-value").val();
                let unit = $("#time-unit").val();
                let window_size = $("#window-size").val();
                if (window_size < 3) {
                    $("#wd-size-error").text("Window size must be greater than 3. Set to default 4").show();
                    return;
                } else {
                    if (!Number.isInteger(window_size) || window_size === '' || isNaN(window_size)) {
                        $("#wd-size-error").text("Window size must be must be Integer. Set to default 4").show();
                        return;
                    } else {
                        $("#wd-size-error").hide();   
                    }
                }
                fetchData(range, unit, window_size, filename);
            }
        });
    </script>
</body>
</html>