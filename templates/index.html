<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script>
        async function pickDirectory(inputId) {
            try {
                const dirHandle = await window.showDirectoryPicker();
                // Get the server-provided directory, ensuring it's defined
                let basePath = "{{ directory | default('') }}";
                // Detect the server's path separator from basePath
                const separator = basePath.includes('\\') ? '\\' : '/';
                // Normalize basePath by removing trailing separators
                basePath = basePath.replace(/[\\\/]+$/, '');
                let fullPath;

                // Construct path with the appropriate separator
                if (basePath) {
                    fullPath = `${basePath}${separator}${dirHandle.name}`;
                } else {
                    fullPath = dirHandle.name;
                }

                // Update the input field with the constructed path
                const pathDisplay = document.getElementById(inputId);
                pathDisplay.value = fullPath;

                // Store the dirHandle for client-side file operations
                window[inputId + 'Handle'] = dirHandle;

                // Warn if no base path is provided
                if (!basePath) {
                    console.warn('No base path provided by server; using directory name only.');
                }
            } catch (err) {
                console.error('Directory selection canceled or failed:', err);
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>{{ title }}</h1>
        
        <div class="section">
            <h2>Directory</h2>
            <input type="text" id="directory" value="{{ directory }}" onchange="updateDirectory(this.value, true)">
            <button onclick="browseDirectory()">Browse Path</button>
            <div id="dir-suggestions">
                <h3>Go back</h3>
                <div id="parent-dir"></div>
                <h3>Go forward</h3>
                <div id="child-dirs"></div>
            </div>
            <div id="error-message"></div>
        </div>
        <div class="section">
            <h2>{{ mode_input.title }}</h2>
            <select id="measurement-mode">
                {% for mode in mode_input.modes %}
                <option value="{{ mode }}">{{ mode }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="section script-controls" id="log-hid-data">
            <h2>Log HID Data</h2>
            <div>
                <label for="base-dir">Base Directory (--base-dir): </label>
                <input type="text" id="base-dir" readonly style="width: 80%">
                <button onclick="pickDirectory('base-dir')">Select Directory</button>
            </div>
            <div>
                <label for="base-name">Base Name (--base-name): </label>
                <input type="text" id="base-name" placeholder="Enter a name for pattern for recorded data files' names" style="width: 10em">
            </div>
            <button id="run-script-btn" onclick="runScript()">Run Script</button>
            <button id="terminate-script-btn" onclick="terminateScript()" disabled>Terminate Script</button>
            <button id="clear-logs-btn" onclick="clearLogs()">Clear Logs</button>
            <button id="go-to-btn" onclick="updateDirectory($('#directory').val(), true)" disabled="">Browse Saving Location</button>
            <div id="log-display"></div>
        </div>
        <div class="section" id="cal-json-exp-section"> 
            <h3>Select type of Calibration you'd like to do</h3>
            <select id="cal-mode-select">
                <option value="kinetics">kinetics</option>
                <option value="point">point</option>
            </select>
        </div>  
        <div class="section" id="cal-json-sel-section">
            <h2>Select Coefficients for standard line</h2>
            <div id="file-table-container">
                <table id="json-table">
                    <tr><th>Calibrated JSON</th><th>Action</th></tr>
                    {% if cal_json_list %}
                        {% for file in cal_json_list %}
                        <tr>
                            <td>{{ file }}</td>
                            <td><button onclick="selectFile('{{ file }}', this, '#json-table')">Select</button></td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="2">No Calibrated JSON is available.</td></tr>
                    {% endif %}
                </table> 
            </div>
            <button id="deselect-btn" onclick="deselectFile('#json-table')">Deselect</button>
            <div id="json-display"></div>
        </div>
        <div class="section">
            <h2>File Selection</h2>
            <div id="file-table-container">
                <table id="file-table">
                    <tr><th>File Name</th><th>Action</th></tr>
                    {% if file_list %}
                        {% for file in file_list %}
                        <tr>
                            <td>{{ file }}</td>
                            <td><button onclick="selectFile('{{ file }}', this)">Select</button></td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="2">No CSV files found in the directory.</td></tr>
                    {% endif %}
                </table>
            </div>
            <button id="deselect-btn" onclick="deselectFile()">Deselect</button>
        </div>
        <div class="section" id="data-display-section">
            <h2>Data Display</h2>
            <!-- Display selected file name -->
            <div id="selected-file-display">No file selected</div>
            <div id="concentration-reader-section">
                Concentration from the csv is <input type="number" id="con-value-read" value="" min=0 style="width: 5em;"> </input> nM/l
            </div>
            <div class="section" id="point-json-exp-section">
                Reference point is at <span type="number" id="cal-point"></span> 
                <br/>
                <span id="cal-time-unit" style="font-weight: bold;">second</span><span id="add-json-section"></span>
            </div>
            <div class="section" id="window-size-section">
                Select window size for Vmax regression
                <input type="number" id="window-size" value="4" min="3" style="width: 5em;">
                <div id="wd-size-error"></div>
            </div>
            <div class="section" id="select-quantity-section">
                Select quantity to derive concentration from
                <select id="regressed-quantity">
                    {% for quantity in quantity_input.quantities %}
                        {% set transformed = quantity.lower().replace(' ', '_') %}
                        <option value="{{ transformed }}" data-original="{{ quantity }}">{{ quantity }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="select-time-point">
                Select time point to derive concentration from
                <select id="regressed-time-point">
                    <option value=""></option>
                </select> <span style="font-weight: bold;"> minute</span>
            </div>
            <div id="derived-concentration-section">
                Concentration derived from the csv is <span style="font-weight: bold;" id="der-con-value"></span> nM/l
            </div>
            <div id="blank-derived-concentration-section">
                <span style="font-weight: bold;"> Blanked </span>concentration derived from the csv is <span style="font-weight: bold;" id="blank-der-con-value"></span> nM/l
            </div>
            <div id="non-blank-derived-concentration-section">
                <span style="font-weight: bold;"> Non blanked</span> concentration derived from the csv is <span style="font-weight: bold;" id="non-blank-der-con-value"></span> nM/l
            </div>
            <div class="section" id="range-display">
                <h3>{{ range_input.title }}</h3>
                <input type="number" id="range-value" value="{{ range_input.value }}" min="1">
                <select id="time-unit">
                    {% for unit in range_input.units %}
                    <option value="{{ unit }}">{{ unit }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="mode-toggle">
                <label>
                    <input type="checkbox" id="split-mode" onchange="toggleMode()"> Split by Blanked
                </label>
                <label id="full-display-section">
                    <input type="checkbox" id="full-display" onchange="toggleMode()"> Full display: See all data and special lines</p>
                </label>
                <label>
                </label>
            </div>
            <div id="analysis-info"></div>
            <div id="chart-container">
                <canvas id="plot-canvas"></canvas>
                <canvas id="blanked-canvas" style="display: none;"></canvas>
                <canvas id="non-blanked-canvas" style="display: none;"></canvas>
            </div>
            <div id="select-exp-blank-type-meas">
                Select Blank type to export:
                <select id="exp-json-blank-type">
                    <option value="MIXED">MIXED</option>
                    <option value="BLANKED">BLANKED</option>
                    <option value="NON-BLANKED">NON-BLANKED</option>
                </select>
            </div>
            <div id="select-exp-blank-type-cal">
                Select Blank type to regress:
                <select id="exp-json-blank-type">
                    <option value="MIXED">MIXED</option>
                    <option value="BLANKED">BLANKED</option>
                    <option value="NON-BLANKED">NON-BLANKED</option>
                </select>
            </div>
            <div id="select-regress-algo"> 
                Select Regress Algo to export:
                <select id="exp-json-regress-algo">
                    <option value="polynomial">polynomial</option>
                    <option value="linear">linear</option>
                    <option value="logarithmic">logarithmic</option>
                </select>
            </div>
            <div id="export-analysis">
                <div>
                    <h3>Export analysis</h3>
                    <div class="section" id="set-exp-point-section">
                        Set reference point to export: <input type="number" id="exp-json-time-value" style="width: 5em;"> <span style="font-weight: bold;"> minute. </span>
                        <br/>
                        <span id="est-val-exp"></span>
                    </div>
                    <label for="save-dir">Saving Directory: 
                    </label>
                    <input type="text" id="save-dir" readonly style="width: 80%">
                    <button onclick="pickDirectory('save-dir')">Select Directory</button>
                </div>
                <div>
                    <label for="save-file">File Name: </label>
                    <input type="text" id="save-file" placeholder="Enter file name to save analysis data to(e.g., results)" style="width: 10em">
                </div>
                <button id="export-btn" onclick="exportData()">Export Data</button>
                <button id="go-to-exp-btn" onclick="updateDirectory($('#directory').val(), true, true)">Browse Saving Location</button>
                <p id="export-data-warning" style="color: red;"><span style="font-weight: bold;">Warning!</span> Exporting data is only supported when Time unit in <span style="font-weight: bold;">Display Range</span> is set to <span style="font-weight: bold;">"minutes"!</span></p>
            </div>  
            <div id="export-coef">
                <div>
                    <label for="save-file">File Name: </label>
                    <input type="text" id="save-json-file" placeholder="Enter file name to regressed coefficients to(e.g., calibration)" style="width: 10em">
                    <button id="export-json-btn" onclick="exportJSONCoef()">Export Calibrated Coefs</button>
                    <br/>
                    Enter the threshold value for rSquared <input type="number" id="threshold-value" value="0" style="width:10%;">
                </div>
            </div>   
        </div>
    </div>
        <script >const rootPath = "{{ directory | safe}}";
        </script>
        <script src="{{ url_for('static', filename='script/index.js') }}"></script>
        <script src="{{ url_for('static', filename='script/navigation.js') }}"></script>
        <script src="{{ url_for('static', filename='script/hid-logging.js') }}"></script>
        <script src="{{ url_for('static', filename='script/data-handling.js') }}"></script>
        <script src="{{ url_for('static', filename='script/data-display.js') }}"></script>
        <script src="{{ url_for('static', filename='script/calculate.js') }}"></script>
</body>
</html>