<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            display: flex;
            justify-content: center;
        }
        .container {
            max-width: 50vw;
            width: 100%;
        }
        .section { margin-bottom: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        #data-display { max-height: 300px; overflow-y: auto; }
        #error-message { color: red; display: none; }
        #file-table-container { max-height: 120px; overflow-y: auto; }
        #file-table { width: 100%; }
        #file-table tr.selected { background-color: #e0f7fa; }
        #file-table button { cursor: pointer; }
        #directory { width: 70%; }
        #dir-suggestions { margin-top: 5px; }
        #parent-dir, #child-dirs { margin-top: 5px; max-height: 100px; overflow-y: auto; }
        #parent-dir h3, #child-dirs h3 { margin: 0; font-size: 1em; font-weight: bold; }
        #parent-dir div, #child-dirs div { padding: 5px; cursor: pointer; }
        #parent-dir div:hover, #child-dirs div:hover { background-color: #f0f0f0; }
        #deselect-btn { margin-top: 5px; padding: 5px 10px; }
        #plot-canvas, #blanked-canvas, #non-blanked-canvas { width: 100%; height: 280px; }
        #chart-container { display: flex; gap: 20px; flex-direction: column;}
        /*#chart-container canvas { flex: 1; }*/
        #mode-toggle { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ title }}</h1>
        
        <div class="section">
            <h2>Directory</h2>
            <input type="text" id="directory" value="{{ directory }}" readonly>
            <button onclick="browseDirectory()">Browse Path</button>
            <div id="dir-suggestions">
                <h3>Go back</h3>
                <div id="parent-dir">
                </div>
                <h3>Go forward</h3>
                <div id="child-dirs">  
                </div>
            </div>
            <div id="error-message"></div>
        </div>
        
        <div class="section">
            <h2>{{ range_input.title }}</h2>
            <input type="number" id="range-value" value="{{ range_input.value }}" min="1">
            <select id="time-unit">
                {% for unit in range_input.units %}
                <option value="{{ unit }}">{{ unit }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="section">
            <h2>File Selection</h2>
            <div id="file-table-container">
                <table id="file-table">
                    <tr><th>File Name</th><th>Action</th></tr>
                    {% if file_list %}
                        {% for file in file_list %}
                        <tr>
                            <td>{{ file }}</td>
                            <td><button onclick="selectFile('{{ file }}', this)">Select</button></td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="2">No CSV files found in the directory.</td></tr>
                    {% endif %}
                </table>
            </div>
            <button id="deselect-btn" onclick="deselectFile()">Deselect</button>
        </div>
        
        <div class="section">
            <h2>Data Display</h2>
            <div id="mode-toggle">
                <label>
                    <input type="checkbox" id="split-mode" onchange="toggleMode()"> Split by Blanked
                </label>
            </div>
            <div id="chart-container">
                <canvas id="plot-canvas"></canvas>
                <canvas id="blanked-canvas" style="display: none;"></canvas>
                <canvas id="non-blanked-canvas" style="display: none;"></canvas>
            </div>
        </div>
    </div>

    <script>
        let blankedChart = null;
        let nonBlankedChart = null;

        // Initialize directory suggestions on page load
        $(document).ready(function() {
            $.get('/get_parents', function(parentResponse) {
                console.log("Parent directory:", parentResponse.parent);
                let parentHtml = parentResponse.parent ? 
                    `${parentResponse.parent.split('/').pop() ? 
                        `<div onclick="updateDirectory('${parentResponse.parent}')">${parentResponse.parent.split('/').pop()}</div>` : 
                        '<div>No parent directory</div>'}` : 
                    '<div>No parent directory</div>';
                $("#parent-dir").html(parentHtml);

                $.get('/get_children', function(childResponse) {
                    console.log("Child directories:", childResponse.children);
                    let childHtml = childResponse.children.length > 0 ? 
                        `${childResponse.children.map(dir => 
                            `<div onclick="updateDirectory('${dir}')">${dir.split('/').pop()}</div>`
                        ).join('')}` : 
                        '<div>No child directories</div>';
                    $("#child-dirs").html(childHtml);
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.log("Error fetching child directories:", textStatus, errorThrown);
                    $("#error-message").text("Error fetching child directories").show();
                });
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.log("Error fetching parent directory:", textStatus, errorThrown);
                $("#error-message").text("Error fetching parent directory").show();
            });
        });

        function browseDirectory() {
            $.get('/get_parents', function(parentResponse) {
                console.log("Parent directory:", parentResponse.parent);
                let parentHtml = parentResponse.parent ? 
                    `${parentResponse.parent.split('/').pop() ? 
                        `<div onclick="updateDirectory('${parentResponse.parent}')">${parentResponse.parent.split('/').pop()}</div>` : 
                        '<div>No parent directory</div>'}` : 
                    '<div>No parent directory</div>';
                $("#parent-dir").html(parentHtml);

                $.get('/get_children', function(childResponse) {
                    console.log("Child directories:", childResponse.children);
                    let childHtml = childResponse.children.length > 0 ? 
                        `${childResponse.children.map(dir => 
                            `<div onclick="updateDirectory('${dir}')">${dir.split('/').pop()}</div>`
                        ).join('')}` : 
                        '<div>No child directories</div>';
                    $("#child-dirs").html(childHtml);
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.log("Error fetching child directories:", textStatus, errorThrown);
                    $("#error-message").text("Error fetching child directories").show();
                });
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.log("Error fetching parent directory:", textStatus, errorThrown);
                $("#error-message").text("Error fetching parent directory").show();
            });
        }

        function updateDirectory(path) {
            console.log("Sending path to server:", path);
            $.post('/browse', {path: path}, function(response) {
                console.log("Server response:", response);
                if (response.status === 'success') {
                    $("#directory").val(response.path);
                    $("#error-message").hide();
                    updateFileTable(response.files);
                    deselectFile();
                } else {
                    $("#error-message").text(response.message).show();
                }
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.log("AJAX error:", textStatus, errorThrown);
                $("#error-message").text("Error updating directory").show();
            });
        }

        function updateFileTable(files) {
            console.log("Updating file table with:", files);
            let html = '<tr><th>File Name</th><th>Action</th></tr>';
            if (files && files.length > 0) {
                files.forEach(file => {
                    html += `<tr><td>${file}</td><td><button onclick="selectFile('${file}', this)">Select</button></td></tr>`;
                });
            } else {
                html += '<tr><td colspan="2">No CSV files found in the directory.</td></tr>';
            }
            $("#file-table").html(html);
            currentFile = null;
            $("#file-table tr").removeClass("selected");
        }

        function selectFile(filename, button) {
            console.log("Selected file:", filename);
            $("#file-table tr").removeClass("selected");
            $(button).closest("tr").addClass("selected");
            let range = $("#range-value").val();
            let unit = $("#time-unit").val();
            fetchData(range, unit, filename);
            currentFile = filename;
        }

        function deselectFile() {
            console.log("Deselecting file");
            $("#file-table tr").removeClass("selected");
            destroyCharts();
            $("#plot-canvas, #blanked-canvas, #non-blanked-canvas").hide();
            currentFile = null;
        }

        function fetchData(range, unit, filename) {
            $.get('/get_data', {
                file: $("#directory").val() + '/' + filename,
                range: range,
                unit: unit
            }, function(response) {
                console.log("Data response:", response);
                if (response.data && response.data.length > 0) {
                    const isSplitMode = $("#split-mode").is(":checked");
                    updatePlot(response.data, range, unit, response.unit || "NONE", isSplitMode);
                } else {
                    $("#data-display").html(response.error || 'No data available');
                }
            });
        }

        function destroyCharts() {
            if (window.myChart) {
                window.myChart.destroy();
                window.myChart = null;
            }
            if (blankedChart) {
                blankedChart.destroy();
                blankedChart = null;
            }
            if (nonBlankedChart) {
                nonBlankedChart.destroy();
                nonBlankedChart = null;
            }
        }

        function toggleMode() {
            if (currentFile) {
                let range = $("#range-value").val();
                let unit = $("#time-unit").val();
                fetchData(range, unit, currentFile);
            }
        }

        function createChart(canvasId, timestamps, values, label, unit, timeUnit) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: label,
                        data: values,
                        borderColor: canvasId === 'blanked-canvas' ? 'rgb(255, 99, 132)' : 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    animation: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: `Time (${timeUnit})`
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: unit !== "NONE" ? unit : ''
                            }
                        }
                    }
                }
            });
        }

        function updatePlot(data, range, timeUnit, unit, isSplitMode) {
            destroyCharts();
            $("#plot-canvas, #blanked-canvas, #non-blanked-canvas").hide();

            // Convert timestamps to the selected time unit
            const baseMultiplier = getTimeUnitMultiplier('seconds');
            const targetMultiplier = getTimeUnitMultiplier(timeUnit);
            const conversionFactor = targetMultiplier / baseMultiplier;

            // Filter data for the latest 'range' in the selected time unit
            const mostRecentTime = Math.max(...data.map(row => row['Timestamp'] * conversionFactor));
            const filteredData = data.filter(row => {
                const timestamp = row['Timestamp'] * conversionFactor;
                return timestamp >= mostRecentTime - (range * conversionFactor);
            });

            const timestamps = filteredData.map(row => Number((row['Timestamp'] * conversionFactor).toFixed(2)));
            const measurementLabel = filteredData.length > 0 && 'Measurement' in filteredData[0] ? 
                filteredData[0]['Measurement'] : 'Measurement';

            if (isSplitMode) {
                // Split mode: Separate Blanked and Non-Blanked data
                const blankedData = filteredData.filter(row => row['Blanked'] === true || row['Blanked'] === 1);
                const nonBlankedData = filteredData.filter(row => row['Blanked'] === false || row['Blanked'] === 0);

                const blankedTimestamps = blankedData.map(row => Number((row['Timestamp'] * conversionFactor).toFixed(2)));
                const blankedValues = blankedData.map(row => row['Value']);
                const nonBlankedTimestamps = nonBlankedData.map(row => Number((row['Timestamp'] * conversionFactor).toFixed(2)));
                const nonBlankedValues = nonBlankedData.map(row => row['Value']);

                $("#blanked-canvas, #non-blanked-canvas").show();
                blankedChart = createChart(
                    'blanked-canvas',
                    blankedTimestamps,
                    blankedValues,
                    `${measurementLabel} (Blanked) ${unit !== "NONE" ? `(${unit})` : ""}`,
                    unit,
                    timeUnit
                );
                nonBlankedChart = createChart(
                    'non-blanked-canvas',
                    nonBlankedTimestamps,
                    nonBlankedValues,
                    `${measurementLabel} (Non-Blanked) ${unit !== "NONE" ? `(${unit})` : ""}`,
                    unit,
                    timeUnit
                );
            } else {
                // All data mode
                const values = filteredData.map(row => row['Value']);
                $("#plot-canvas").show();
                window.myChart = createChart(
                    'plot-canvas',
                    timestamps,
                    values,
                    `${measurementLabel} ${unit !== "NONE" ? `(${unit})` : ""}`,
                    unit,
                    timeUnit
                );
            }
        }

        function getTimeUnitMultiplier(unit) {
            const multipliers = {
                'seconds': 1,
                'minutes': 1/60,
                'hours': 1/3600,
                'milli-sec': 1000
            };
            return multipliers[unit] || 1;
        }

        let currentFile = null;
        setInterval(function() {
            if (currentFile) {
                let range = $("#range-value").val();
                let unit = $("#time-unit").val();
                fetchData(range, unit, currentFile);
            }
        }, 5000);

        // Add event listeners to update plot when range, unit, or mode changes
        $("#range-value, #time-unit").on('change', function() {
            if (currentFile) {
                let range = $("#range-value").val();
                let unit = $("#time-unit").val();
                fetchData(range, unit, currentFile);
            }
        });
    </script>
</body>
</html>